<div class="container-fluid">
  <div *ngIf="isLoading" class="loading-overlay">
    <div class="loading-content">
      <mat-spinner diameter="50"></mat-spinner>
      <p class="loading-text">Cargando Ministros de Fe...</p>
    </div>
  </div>
  
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a routerLink="/">Inicio</a></li>
      <li class="breadcrumb-item active" aria-current="page">Ministro de Fe</li>
    </ol>
  </nav>

  <!-- Título -->
  <div class="page-header">
    <h2 class="page-title">Ministro de Fe</h2>
  </div>

  <!-- Pestañas modernos -->
  <div class="tabs-section">
    <div class="modern-tabs">
      <div class="tabs-container">
        <button 
          class="tab-button" 
          *ngFor="let tab of tabs"
          [class.active]="currentTab === tab.id"
          (click)="setTab(tab.id)">
          <span class="tab-label">{{ tab.label }}</span>
          <span class="tab-count">({{ tab.count() }})</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Sección de filtros mejorada -->
  <div class="filters-section">
    <div class="filters-header" (click)="showFilters = !showFilters">
      <span class="filters-title">
        <mat-icon class="filters-icon">filter_list</mat-icon>
        Filtros avanzados
      </span>
      <mat-icon class="toggle-icon" [class.rotated]="showFilters">
        keyboard_arrow_down
      </mat-icon>
    </div>

    <div class="filters-container" [class.expanded]="showFilters">
      <div class="filters-content">
        <div class="row g-3">
          <!-- Enviado por -->
          <div class="col-lg-2 col-md-3 col-sm-6">
            <mat-form-field appearance="outline" class="modern-form-field">
              <mat-label>Enviado por</mat-label>
              <input matInput [formControl]="enviadoPor">
            </mat-form-field>
          </div>

          <!-- Fecha Declaración -->
          <div class="col-lg-2 col-md-3 col-sm-6">
            <mat-form-field appearance="outline" class="modern-form-field">
              <mat-label>Fecha Declaración</mat-label>
              <input matInput [matDatepicker]="pickerDec" [formControl]="fechaDeclaracion">
              <mat-datepicker-toggle matSuffix [for]="pickerDec"></mat-datepicker-toggle>
              <mat-datepicker #pickerDec></mat-datepicker>
            </mat-form-field>
          </div>

          <!-- Tipo -->
          <div class="col-lg-2 col-md-3 col-sm-6">
            <mat-form-field appearance="outline" class="modern-form-field">
              <mat-label>Tipo</mat-label>
              <mat-select [formControl]="tipoDeclaracion">
                <mat-option *ngFor="let t of tipos" [value]="t.id">{{ t.nombre }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- R.U.N. -->
          <div class="col-lg-2 col-md-3 col-sm-6">
            <mat-form-field appearance="outline" class="modern-form-field">
              <mat-label>R.U.N.</mat-label>
              <input matInput [formControl]="run">
            </mat-form-field>
          </div>

          <!-- Declarante -->
          <div class="col-lg-2 col-md-3 col-sm-6">
            <mat-form-field appearance="outline" class="modern-form-field">
              <mat-label>Declarante</mat-label>
              <input matInput [formControl]="declarante">
            </mat-form-field>
          </div>

          <!-- Servicio -->
          <div class="col-lg-2 col-md-3 col-sm-6">
            <mat-form-field appearance="outline" class="modern-form-field">
              <mat-label>Servicio</mat-label>
              <mat-select [formControl]="servicio">
                <mat-option *ngFor="let s of serviciosCombo" [value]="s.id">{{ s.nombre }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Cargo -->
          <div class="col-lg-2 col-md-3 col-sm-6">
            <mat-form-field appearance="outline" class="modern-form-field">
              <mat-label>Cargo</mat-label>
              <input matInput [formControl]="cargo">
            </mat-form-field>
          </div>

          <!-- Estado -->
          <div class="col-lg-2 col-md-3 col-sm-6">
            <mat-form-field appearance="outline" class="modern-form-field">
              <mat-label>Estado</mat-label>
              <mat-select [formControl]="estado">
                <mat-option *ngFor="let e of estados" [value]="e.id">{{ e.nombre }}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        <div class="filters-actions">
          <button mat-raised-button color="primary" class="action-btn" (click)="buscar()">
            <mat-icon>search</mat-icon>
            Buscar
          </button>
          <button mat-raised-button color="warn" class="action-btn" (click)="limpiar()">
            <mat-icon>clear</mat-icon>
            Limpiar
          </button>
          <button mat-raised-button color="accent" class="action-btn" (click)="exportar()">
            <mat-icon>download</mat-icon>
            Exportar
          </button>
        </div>
      </div>
    </div>
  </div>

<!-- VISTA DE ESCRITORIO -->
<div class="d-none d-md-block desktop-view">
  <!-- Barra de acciones superior -->
  <div class="table-header">
    <div class="table-actions">
      <button mat-raised-button color="primary" class="primary-action-btn" (click)="descargarVersionCompleta()">
        <mat-icon>download</mat-icon>
        Descargar Seleccionados
      </button>
    </div>
  </div>

  <!-- Tabla con diseño mejorado -->
  <div class="table-container">
    <table mat-table [dataSource]="getDataSource(currentTab)" class="modern-table">
      <!-- Checkbox -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef class="header-cell checkbox-cell">
          <mat-checkbox color="primary" 
                        (change)="masterToggle(currentTab)" 
                        [checked]="isAllSelected(currentTab)"
                        [indeterminate]="isSomeSelected(currentTab)">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let element" class="data-cell checkbox-cell">
          <mat-checkbox color="primary" 
                        (click)="$event.stopPropagation()" 
                        (change)="toggle(currentTab, element)"
                        [checked]="isSelected(currentTab, element)">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Id -->
      <ng-container matColumnDef="idDeclaracion">
        <th mat-header-cell *matHeaderCellDef class="header-cell">Id Declaración</th>
        <td mat-cell *matCellDef="let e" class="data-cell">{{ e.id }}</td>
      </ng-container>

      <!-- Fecha -->
      <ng-container matColumnDef="fechaDeclaracion">
        <th mat-header-cell *matHeaderCellDef class="header-cell">Fecha Declaración</th>
        <td mat-cell *matCellDef="let e" class="data-cell">{{ e.fechaFirmaDeclarante }}</td>
      </ng-container>

      <!-- Tipo -->
      <ng-container matColumnDef="tipoDeclaracion">
        <th mat-header-cell *matHeaderCellDef class="header-cell">Tipo Declaración</th>
        <td mat-cell *matCellDef="let e" class="data-cell">{{ e.declaTipo }}</td>
      </ng-container>

      <!-- Numeral -->
      <ng-container matColumnDef="numeral">
        <th mat-header-cell *matHeaderCellDef class="header-cell">Numeral</th>
        <td mat-cell *matCellDef="let e" class="data-cell">{{ e.sujetoObligado }}</td>
      </ng-container>

      <!-- RUT -->
      <ng-container matColumnDef="rut">
        <th mat-header-cell *matHeaderCellDef class="header-cell">RUT</th>
        <td mat-cell *matCellDef="let e" class="data-cell">{{ e.rut }}</td>
      </ng-container>

      <!-- Declarante -->
      <ng-container matColumnDef="declarante">
        <th mat-header-cell *matHeaderCellDef class="header-cell">Declarante</th>
        <td mat-cell *matCellDef="let e" class="data-cell">{{ e.declarante }}</td>
      </ng-container>

      <!-- Servicio -->
      <ng-container matColumnDef="servicio">
        <th mat-header-cell *matHeaderCellDef class="header-cell">Servicio</th>
        <td mat-cell *matCellDef="let e" class="data-cell">{{ e.servicio }}</td>
      </ng-container>

      <!-- Cargo -->
      <ng-container matColumnDef="cargo">
        <th mat-header-cell *matHeaderCellDef class="header-cell">Cargo</th>
        <td mat-cell *matCellDef="let e" class="data-cell">{{ e.cargo }}</td>
      </ng-container>

      <!-- Estado -->
      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef class="header-cell">Estado</th>
        <td mat-cell *matCellDef="let e" class="data-cell">
          <span [ngClass]="pillClass(e.declaEstado)" class="modern-estado-pill">{{ e.declaEstado }}</span>
        </td>
      </ng-container>

      <!-- Enviado por -->
      <ng-container matColumnDef="enviadoPor">
        <th mat-header-cell *matHeaderCellDef class="header-cell">Enviado por</th>
        <td mat-cell *matCellDef="let e" class="data-cell">{{ e.remitente }}</td>
      </ng-container>

      <!-- Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef class="header-cell">Acciones</th>
        <td mat-cell *matCellDef="let e" class="actions-cell">
          <div class="action-buttons">
            <button mat-icon-button color="primary" (click)="onBitacora(e)" matTooltip="Bitácora" class="action-btn">
              <img src="assets/icons/icon-btn-tabla_bitacora.svg" alt="Bitacora">
            </button>
            <button mat-icon-button color="accent" (click)="onDerivar()" matTooltip="Derivar" class="action-btn">
              <img src="assets/icons/icon-btn-tabla_archivar.svg" alt="Derivar">
            </button>
            <button mat-icon-button color="warn" (click)="onFirmar()" matTooltip="Firmar" class="action-btn">
              <img src="assets/icons/icon-btn-tabla_archivar.svg" alt="Firmar">
            </button>
            <button mat-icon-button color="primary" (click)="onEnviarOrganismo()" matTooltip="Enviar a Organismo Fiscalizador" class="action-btn">
              <img src="assets/icons/icon-btn-tabla_archivar.svg" alt="Enviar a Organismo Fiscalizador">
            </button>
          </div>
        </td>
      </ng-container>

      <!-- Filas -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns" class="header-row"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="data-row"></tr>
    </table>
  </div>

  <!-- Paginador mejorado -->
  <div class="pagination-container">
    <mat-paginator 
      class="modern-paginator" 
      [pageSizeOptions]="[5, 10, 20]" 
      showFirstLastButtons 
      [length]="getDataSource(currentTab)?.data?.length"
      aria-label="Paginador de Ministros de Fe">
    </mat-paginator>
  </div>
</div>

<!-- VISTA MOBILE -->
<div class="d-block d-md-none mobile-view">
  <!-- Botón de acción principal en mobile -->
  <div class="mobile-actions">
    <button mat-raised-button color="primary" class="mobile-primary-btn" (click)="descargarVersionCompleta()">
      <mat-icon>download</mat-icon>
      Descargar Seleccionados
    </button>
  </div>

  <!-- Lista de tarjetas mobile -->
  <div class="mobile-list" [class.loading]="isLoading">
    <div class="mobile-card" *ngFor="let e of getDataSource(currentTab).data">
      <div class="card-header">
        <div class="card-title">
          <mat-checkbox color="primary"
                        (click)="$event.stopPropagation()"
                        (change)="toggle(currentTab, e)"
                        [checked]="isSelected(currentTab, e)"
                        class="card-checkbox">
          </mat-checkbox>
          <span class="declaration-number">ID: {{ e.idDeclaracion }}</span>
        </div>
        <div class="card-actions">
          <button mat-icon-button [matMenuTriggerFor]="menu" class="menu-btn">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="onBitacora(e); $event.stopPropagation()">
              <mat-icon>list</mat-icon>
              <span>Bitácora</span>
            </button>
            <button mat-menu-item (click)="onDerivar(); $event.stopPropagation()">
              <mat-icon>send</mat-icon>
              <span>Derivar</span>
            </button>
            <button mat-menu-item (click)="onFirmar(); $event.stopPropagation()">
              <mat-icon>edit</mat-icon>
              <span>Firmar</span>
            </button>
            <button mat-menu-item (click)="onEnviarOrganismo(); $event.stopPropagation()">
              <mat-icon>business</mat-icon>
              <span>Enviar a Organismo Fiscalizador</span>
            </button>
          </mat-menu>
        </div>
      </div>
      
      <div class="card-content">
        <div class="info-row">
          <span class="info-label">Fecha Declaración:</span>
          <span class="info-value">{{ e.fechaDeclaracion }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Tipo Declaración:</span>
          <span class="info-value">{{ e.tipoDeclaracion }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Numeral:</span>
          <span class="info-value">{{ e.numeral }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">RUT:</span>
          <span class="info-value">{{ e.rut }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Declarante:</span>
          <span class="info-value">{{ e.declarante }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Servicio:</span>
          <span class="info-value">{{ e.servicio }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Cargo:</span>
          <span class="info-value">{{ e.cargo }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Estado:</span>
          <span [ngClass]="pillClass(e.estado)" class="modern-estado-pill">
            {{ e.estado }}
          </span>
        </div>
        <div class="info-row">
          <span class="info-label">Enviado por:</span>
          <span class="info-value">{{ e.enviadoPor }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Paginador mobile -->
  <div class="mobile-pagination">
    <mat-paginator 
      class="modern-paginator" 
      [pageSizeOptions]="[5, 10, 20]" 
      showFirstLastButtons 
      [length]="getDataSource(currentTab)?.data?.length"
      aria-label="Paginador de Ministros de Fe">
    </mat-paginator>
  </div>
</div>

<!-- Modal de Bitácora -->
<div class="bitacora-modal-overlay" *ngIf="showBitacoraModal" (click)="cerrarBitacoraModal()">
  <div class="bitacora-modal-container" (click)="$event.stopPropagation()">
    <!-- Header del modal -->
    <div class="bitacora-modal-header">
      <div class="modal-title">
        <mat-icon class="modal-icon">history</mat-icon>
        <h3>Bitácora de Declaración #{{ currentDeclaracionId }}</h3>
      </div>
      <button mat-icon-button class="close-btn" (click)="cerrarBitacoraModal()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Contenido del modal -->
    <div class="bitacora-modal-content">
      <!-- Spinner de carga -->
      <div *ngIf="bitacoraLoading" class="bitacora-loading">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Cargando bitácora...</p>
      </div>

      <!-- Tabla de bitácoras -->
      <div *ngIf="!bitacoraLoading && bitacoraData.length > 0" class="bitacora-table-container">
        <table class="bitacora-table">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Fecha</th>
              <th>Acción</th>
              <th>Perfil</th>
              <th>Observaciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let bitacora of bitacoraData; let i = index" 
                [class.even-row]="i % 2 === 0">
              <td class="usuario-cell">
                <div class="usuario-info">
                  <mat-icon class="user-icon">person</mat-icon>
                  <span>{{ bitacora.usuario }}</span>
                </div>
              </td>
              <td class="fecha-cell">
                <div class="fecha-info">
                  <mat-icon class="date-icon">schedule</mat-icon>
                  <span>{{ bitacora.fecha }}</span>
                </div>
              </td>
              <td class="accion-cell">
                <span [ngClass]="getAccionPillClass(bitacora.accion)" class="accion-pill">
                  {{ bitacora.accion }}
                </span>
              </td>
              <td class="perfil-cell">
                <div class="perfil-badge">
                  <mat-icon class="role-icon">badge</mat-icon>
                  <span>{{ bitacora.perfil }}</span>
                </div>
              </td>
              <td class="observaciones-cell">
                <div class="observaciones-content" [matTooltip]="bitacora.observaciones">
                  {{ bitacora.observaciones }}
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Mensaje cuando no hay datos -->
      <div *ngIf="!bitacoraLoading && bitacoraData.length === 0" class="bitacora-empty">
        <mat-icon class="empty-icon">info</mat-icon>
        <p>No hay registros de bitácora para esta declaración.</p>
      </div>
    </div>

    <!-- Footer del modal con paginación -->
    <div class="bitacora-modal-footer" *ngIf="bitacoraData.length > 0">
      <mat-paginator 
        class="bitacora-paginator"
        [length]="bitacoraTotalItems"
        [pageSize]="bitacoraPageSize"
        [pageIndex]="bitacoraCurrentPage"
        [pageSizeOptions]="[5, 10, 15]"
        (page)="onBitacoraPaginaChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </div>
  </div>
</div>

</div>